# MSA 打包重构方案书

## 第一阶段：清理 M9A 残留（可直接执行）

### 1. 产物命名修正

- install.yml：所有 artifact name 中 M9A → MSA
- tools/ci/install.py:custom_title 改为 f"MSA {version} | 天狼星小助手"
- tools/ci/install_cli.py:同上

### 2. 删除 drop_core 私有模块

- 删除 tools/ci/download_drop_core.py
- 删除 install.yml 中三处 Download drop_core module 步骤
- 已确认 agent/ 中无 drop_core 相关引用，无需额外清理

### 3. 删除 registry 无效引用

- 删除 install.yml 的 cp -rpvn tools/registry/. install/
- 删除 install.yml 的 cp -rpvn tools/registry/. install-cli/

### 4. 删除 CONTACT 引用

- tools/ci/install.py:从文件列表中移除 "CONTACT"
- tools/ci/install_cli.py:同上

### 5. 注释 Mirror酱触发

- 注释 install.yml:Trigger MirrorChyanUploading 步骤

### 6. 修复 icon 路径

- install.yml 中所有 assets/logo.png → assets/logo/blue.png（暂时统一用 blue，双版本在第三阶段处理）
- 输出文件名 m9a.ico → msa.ico，并同步修改后续引用

## 第二阶段：禁用暂不需要的功能

### 1. 热更新暂停

- agent/main.py：注释热更新代码块（保留版本检查）
- agent/utils/version_checker.py:user_agent=M9A-Agent 改为 user_agent=MSA-Agent
- tools/ci/install.py 和 install_cli.py:注释 install_manifest_cache() 调用
- tools/ci/install.py 和 install_cli.py:注释 from generate_manifest_cache import generate_manifest_cache
- tools/ci/generate_manifest_cache.py：将 <https://api.1999.fan/api> 注释或改为占位符

### 2. 注释非 Windows 平台和 CLI 版

- 注释 install.yml 中 linux job
- 注释 install.yml 中 macos job
- 注释 Windows job 中 Create CLI version 步骤
- 注释 Lite 版的 upload-artifact 步骤
- release job 的 needs 改为 [meta, windows, changelog]

### 3. 使用最新框架和 GUI

- 删除 env 中的 MAA_FRAMEWORK_VERSION 和 MFAA_VERSION
- robinraju/release-downloader 的调用中：删除 tag 参数，添加 latest: true
- 在下载步骤后添加 echo 打印实际下载的版本号，便于排查

## 第三阶段：双产物打包

整体思路：workflow 中先完成原版打包，然后复制一份原版产物，用独立脚本改造为后台版。

### 1. 新增 Hook 构建步骤

- 在 Windows job 中、Install 步骤之前，添加 CMake 构建 hook 模块的步骤
- 产物路径：hook/build/bin/Release/msa_hook.dll 和 hook/build/bin/Release/MaaWin32ControlUnit.dll
- 仅在 x86_64 架构上构建（MinHook 不支持 ARM64），aarch64 只产出原版

### 2. 图标处理改造

- 生成两个 ico：
  - assets/logo/blue.png → msa-base.ico（原版）
  - assets/logo/pink.png → msa-bg.ico（后台版）
- 原版用 msa-base.ico 修改 MFAAvalonia.exe 图标
- 后台版用 msa-bg.ico

### 3. 新增后台版转换脚本 tools/ci/create_background_variant.py

输入：已完成的原版 install/ 目录、Hook 构建产物路径
重要说明:MaaWin32ControlUnit.dll 在原版打包的 install.py 被排除是正常现象,因为它已经由 MFAAvalonia 自带，因此 install.py 选择在复制自行下载的依赖时将其排除防止与 MFAAvalonia 冲突，实际构建产物中带有 MaaWin32ControlUnit.dll ,不会产生文件缺失问题.

职责：

1. 将 install/ 复制为 install-bg/
2. 在 install-bg/runtimes/win-x64/native/ 中：
   - 将 MaaWin32ControlUnit.dll 重命名为 MaaWin32ControlUnit_original.dll
   - 复制代理 MaaWin32ControlUnit.dll（Hook 构建产物）
   - 复制 msa_hook.dll（Hook 构建产物）
3. 修改 install-bg/interface.json 中的 controller 配置：
   - 确保 mouse 为 "SendMessage"，keyboard 为 "SendMessage"
4. 替换 install-bg/assets/logo.ico 为后台版图标

### 4. 原版 interface.json 修改

- 在 tools/ci/install.py 的 install_resource() 中增加逻辑：将 mouse 改为 "Seize"，keyboard 改为 "Seize"（原版前台控制方式）
- 或者在 workflow 中调用转换脚本前，先修改原版的 controller 配置
- 重要说明:原版与后台版的输入方式均与源码不一致是故意为之的正常现象,不用修改.

### 5. Workflow 中的打包流程调整

在 Windows x86_64 job 中，现有步骤之后追加：

- name: Create Background variant (x86_64 only)
    if: matrix.arch == 'x86_64'
    shell: bash
    run: |
      ./install/python/python.exe ./tools/ci/create_background_variant.py \
        --hook-dir hook/build/bin/Release \
        --icon msa-bg.ico

### 6. 产物上传

- 原版：MSA-win-{arch}-{tag}-Base
- 后台版（仅 x86_64）：MSA-win-x86_64-{tag}-Background
- release job 中同步处理新增的 artifact
